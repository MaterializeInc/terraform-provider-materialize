name: test
on:
  pull_request:
    paths:
      - pkg/**
      - main.go
      - go.mod

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Run Tests with Coverage
        run: |
          set -e
          retries=3
          count=0
          until [ $count -ge $retries ]
          do
            go test -v -coverprofile=coverage.out -covermode=atomic ./... && break
            count=$((count+1))
            echo "Retrying tests... Attempt $count of $retries"
          done
          if [ $count -ge $retries ]; then
            echo "Tests failed after $retries attempts."
            exit 1
          fi

      - name: Generate Coverage Report
        run: |
          # Generate human-readable coverage report
          go tool cover -func=coverage.out -o=coverage.txt

          # Extract overall coverage
          TOTAL_COV=$(tail -1 coverage.txt | awk '{print $NF}')

          # Build markdown report
          {
            echo "## Test Coverage Summary"
            echo ""
            echo "**Overall Coverage: $TOTAL_COV**"
            echo ""
            echo "### Coverage by Package"
            echo ""
            echo "| Package | Coverage |"
            echo "|---------|----------|"

            # Calculate and display per-package coverage (excluding testhelpers)
            for pkg in clients datasources frontegg materialize provider resources utils; do
              PKG_COV=$(grep "pkg/$pkg/" coverage.txt | awk '{gsub(/%/, "", $NF); sum+=$NF; count++} END {if(count>0) printf "%.1f%%", sum/count}')
              [ -n "$PKG_COV" ] && [ "$PKG_COV" != "0.0%" ] && echo "| pkg/$pkg | $PKG_COV |"
            done

            echo ""

            # Check against 50% threshold
            COV_NUM=$(echo "$TOTAL_COV" | sed 's/%//')
            if (( $(echo "$COV_NUM < 50" | bc -l) )); then
              echo "⚠️ **Warning:** Coverage is below 50% threshold"
            else
              echo "✅ Coverage meets minimum threshold (50%)"
            fi
          } >> $GITHUB_STEP_SUMMARY

      - name: Archive Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.txt
          retention-days: 30
